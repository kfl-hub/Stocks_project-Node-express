"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AutoIncrementID = exports.AutoIncrementIDSkipSymbol = exports.AutoIncrementSimple = exports.isNullOrUndefined = void 0;
const tslib_1 = require("tslib");
const mongoose = require("mongoose");
const logSettings_1 = require("./logSettings");
const DEFAULT_INCREMENT = 1;
/**
 * Because since node 4.0.0 the internal util.is* functions got deprecated
 * @param val Any value to test if null or undefined
 */
function isNullOrUndefined(val) {
    return val === null || val === undefined;
}
exports.isNullOrUndefined = isNullOrUndefined;
/**
 * The Plugin - Simple version
 * Increments an value each time it is saved
 * @param schema The Schema
 * @param options The Options
 */
function AutoIncrementSimple(schema, options) {
    // convert normal object into an array
    const fields = Array.isArray(options) ? options : [options];
    logSettings_1.logger.info('Initilaize AutoIncrement for an schema with %d fields to increment', fields.length);
    if (fields.length <= 0) {
        throw new Error('Options with at least one field are required!');
    }
    // check if all fields are valid
    for (const field of fields) {
        if (typeof field.field != 'string') {
            throw new Error(`Got Field object, but did not contain a "field" key with "string" value, got: ${JSON.stringify(field)}`);
        }
        const schemaField = schema.path(field.field);
        // check if the field is even existing
        if (isNullOrUndefined(schemaField)) {
            throw new Error(`Field "${field.field}" does not exists on the Schema!`);
        }
        // check if the field is an number
        if (schemaField.instance !== 'Number' && schemaField.instance !== 'BigInt') {
            throw new Error(`Field "${field.field}" is not a Number or BigInt!`);
        }
        if (isNullOrUndefined(field.incrementBy)) {
            logSettings_1.logger.info('Field "%s" does not have an incrementBy defined, defaulting to %d', field.field, DEFAULT_INCREMENT);
            if (schemaField.instance === 'BigInt') {
                field.incrementBy = BigInt(DEFAULT_INCREMENT);
            }
            else {
                field.incrementBy = DEFAULT_INCREMENT;
            }
        }
    }
    // to have an name to the function if debugging
    schema.pre('save', function AutoIncrementPreSaveSimple() {
        if (!this.isNew) {
            logSettings_1.logger.info('Starting to increment "%s"', this.constructor.modelName);
            for (const field of fields) {
                logSettings_1.logger.info('Incrementing "%s" by %d', field.field, field.incrementBy);
                // "this as any" is required because mongoose sets a document to default to "unknown" if not explicitly set for hooks
                // but in this case it should work just fine
                this[field.field] += field.incrementBy;
            }
        }
    });
}
exports.AutoIncrementSimple = AutoIncrementSimple;
/** The Schema used for the trackers */
const IDSchema = new mongoose.Schema({
    field: String,
    modelName: String,
    count: BigInt,
}, { versionKey: false });
IDSchema.index({ field: 1, modelName: 1 }, { unique: true });
exports.AutoIncrementIDSkipSymbol = Symbol('AutoIncrementIDSkip');
/**
 * The Plugin - ID
 * Increments an counter in an tracking collection
 * @param schema The Schema
 * @param options The Options
 */
function AutoIncrementID(schema, options) {
    /** The Options with default options applied */
    const opt = {
        field: '_id',
        incrementBy: DEFAULT_INCREMENT,
        trackerCollection: 'identitycounters',
        trackerModelName: 'identitycounter',
        startAt: 0,
        overwriteModelName: '',
        ...options,
    };
    // check if the field is an number
    const schemaField = schema.path(opt.field);
    if (schemaField.instance !== 'Number' && schemaField.instance !== 'BigInt') {
        throw new Error(`Field "${opt.field}" is not a Number or BigInt!`);
    }
    let model;
    logSettings_1.logger.info('AutoIncrementID called with options %O', opt);
    schema.pre('save', async function AutoIncrementPreSaveID() {
        logSettings_1.logger.info('AutoIncrementID PreSave');
        opt.incrementBy = BigInt(opt.incrementBy);
        opt.startAt = BigInt(opt.startAt);
        const originalModelName = this.constructor.modelName;
        let modelName;
        if (typeof opt.overwriteModelName === 'function') {
            modelName = opt.overwriteModelName(originalModelName, this.constructor);
            if (!modelName || typeof modelName !== 'string') {
                throw new Error('"overwriteModelname" is a function, but did return a falsy type or is not a string!');
            }
        }
        else {
            modelName = opt.overwriteModelName || originalModelName;
        }
        if (!model) {
            logSettings_1.logger.info('Creating idtracker model named "%s"', opt.trackerModelName);
            // needs to be done, otherwise "undefiend" error if the plugin is used in an sub-document
            const db = this.db ?? this.ownerDocument().db;
            model = db.model(opt.trackerModelName, IDSchema, opt.trackerCollection);
            // test if the counter document already exists
            const counter = await model
                .findOne({
                modelName: modelName,
                field: opt.field,
            })
                .lean()
                .exec();
            if (!counter) {
                await model.create({
                    modelName: modelName,
                    field: opt.field,
                    count: opt.startAt - opt.incrementBy,
                });
            }
        }
        if (!this.isNew) {
            logSettings_1.logger.info('Document is not new, not incrementing');
            return;
        }
        // @ts-expect-error mongoose now restrics indexes to "string"
        if (typeof this[exports.AutoIncrementIDSkipSymbol] === 'boolean' && exports.AutoIncrementIDSkipSymbol) {
            logSettings_1.logger.info('Symbol "AutoIncrementIDSkipSymbol" is set to "true", skipping');
            return;
        }
        const ownerDocDb = this.db ?? this.ownerDocument().db;
        if (typeof ownerDocDb[exports.AutoIncrementIDSkipSymbol] == 'boolean' && ownerDocDb[exports.AutoIncrementIDSkipSymbol]) {
            logSettings_1.logger.info('Symbol "AutoIncrementIDSkipSymbol" is set on the connection to "true", skipping');
            return;
        }
        const leandoc = await model
            .findOneAndUpdate({
            field: opt.field,
            modelName: modelName,
        }, {
            $inc: { count: opt.incrementBy },
        }, {
            new: true,
            fields: { count: 1, _id: 0 },
            upsert: true,
            setDefaultsOnInsert: true,
        })
            .lean()
            .exec();
        if (isNullOrUndefined(leandoc)) {
            throw new Error(`"findOneAndUpdate" incrementing count failed for "${modelName}" on field "${opt.field}"`);
        }
        logSettings_1.logger.info('Setting "%s" to "%d"', opt.field, leandoc.count);
        this[opt.field] = leandoc.count;
        return;
    });
}
exports.AutoIncrementID = AutoIncrementID;
tslib_1.__exportStar(require("./types"), exports);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0b0luY3JlbWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9hdXRvSW5jcmVtZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxxQ0FBcUM7QUFDckMsK0NBQXVDO0FBR3ZDLE1BQU0saUJBQWlCLEdBQUcsQ0FBQyxDQUFDO0FBRTVCOzs7R0FHRztBQUNILFNBQWdCLGlCQUFpQixDQUFDLEdBQVk7SUFDNUMsT0FBTyxHQUFHLEtBQUssSUFBSSxJQUFJLEdBQUcsS0FBSyxTQUFTLENBQUM7QUFDM0MsQ0FBQztBQUZELDhDQUVDO0FBRUQ7Ozs7O0dBS0c7QUFDSCxTQUFnQixtQkFBbUIsQ0FDakMsTUFBNEIsRUFDNUIsT0FBa0U7SUFFbEUsc0NBQXNDO0lBQ3RDLE1BQU0sTUFBTSxHQUFpQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDMUYsb0JBQU0sQ0FBQyxJQUFJLENBQUMsb0VBQW9FLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRWpHLElBQUksTUFBTSxDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUUsQ0FBQztRQUN2QixNQUFNLElBQUksS0FBSyxDQUFDLCtDQUErQyxDQUFDLENBQUM7SUFDbkUsQ0FBQztJQUVELGdDQUFnQztJQUNoQyxLQUFLLE1BQU0sS0FBSyxJQUFJLE1BQU0sRUFBRSxDQUFDO1FBQzNCLElBQUksT0FBTyxLQUFLLENBQUMsS0FBSyxJQUFJLFFBQVEsRUFBRSxDQUFDO1lBQ25DLE1BQU0sSUFBSSxLQUFLLENBQUMsaUZBQWlGLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzVILENBQUM7UUFFRCxNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU3QyxzQ0FB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